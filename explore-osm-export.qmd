---
title: "Explore OSM Export"
format:
  gfm:
    code-fold: true
    code-summary: "Show the code"
    df-print: paged
---

```{r setup}
# | echo: false

pacman::p_load(
    kableExtra,
    tidyverse,
    skimr)

# read tab delimited file
pharmacies_raw <- read_delim(
    "sh_apotheken.csv", delim = "\t", show_col_types = FALSE)
```

## Cleaning

We are working with a CSV `sh_apotheken.csv` that was generated through a query of the OSM data and is at the moment in the main repo

### Opening Hours: 

**Extract Number of days per week and number of hours per week from opening hours string**

This is not as straight forward since the opening hours are entered by humany and can take different formats. There are a couple of github repos who have already started to tackle this problem. 

- Github repo: https://github.com/opening-hours/opening_hours.js#time-ranges
- OSM Opening Hours Interface: https://openingh.openstreetmap.de/evaluation_tool/?lng=en
- OSM Opening Hours Wiki: https://wiki.openstreetmap.org/wiki/DE:Key:opening_hours

```{r}
# | echo: false
# | message: false

# extract number of days per week

pharmacies_processed <- pharmacies_raw %>% 

    # clean up column names (remove @ and replace : with _)
    rename_all(~str_replace_all(str_remove(.x, "@"), ":", "_")) %>% 

    # flag missing name 
    mutate(flag_missing_name = is.na(name)) %>%

    # extract opening hours
    # nicht die perfekte lÃ¶sung weil zB Mo-Fr nicht abgedeckt
    mutate(opening_days = str_extract_all(opening_hours, "Mo|Di|Mi|Do|Fr|Sa|So"))
```

## Exploring 

### Overall Data Quality

**How many pharmacies are in the dataset? By Bundesland?**

**How many missings do we have in the main columns of interest?**
```{r}
pharmacies_processed %>% 
    skimr::skim(
        name,
        addr_city,
        addr_street,
        opening_hours,
        opening_days
    )
```

**How many duplicate streets do we see?**
```{r}
pharmacies_processed %>% 
	count(addr_street, sort = TRUE) %>% 
    filter(n > 1)
```


for the future:

-   Data Quality: What are potential problems?
-   Data Availability:
    -   Name: Does the entry have a name? -\> if not, filter out
    -   Opening Hours: How many entries have a opening hours?

## Exporting

-   how do we make the data available to the data portal?